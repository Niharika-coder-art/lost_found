import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { AlertTriangle, Plus, XCircle } from 'lucide-react';
import { format } from 'date-fns';
import { toast } from 'sonner';

const VIOLATION_TYPES = ['fake_report', 'spam', 'inappropriate_content', 'misuse', 'other'];

export default function ViolationManagement() {
  const [showAddForm, setShowAddForm] = useState(false);
  const [formData, setFormData] = useState({
    user_email: '',
    violation_type: '',
    description: '',
    severity: 'warning'
  });

  const queryClient = useQueryClient();

  const { data: violations = [] } = useQuery({
    queryKey: ['allViolations'],
    queryFn: () => base44.entities.Violation.list('-created_date', 100),
    initialData: []
  });

  const { data: users = [] } = useQuery({
    queryKey: ['usersForViolations'],
    queryFn: () => base44.entities.User.list(),
    initialData: []
  });

  const addViolationMutation = useMutation({
    mutationFn: async () => {
      const user = users.find(u => u.email === formData.user_email);
      if (!user) throw new Error('User not found');

      const currentAdmin = await base44.auth.me();
      const currentViolationCount = user.violation_count || 0;
      let severity = formData.severity;
      let newStatus = user.account_status;
      let suspensionDate = null;

      // Auto-determine severity based on violation count
      if (currentViolationCount === 0) {
        severity = 'warning';
        newStatus = 'warned';
      } else if (currentViolationCount === 1) {
        severity = 'suspension';
        newStatus = 'suspended';
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 7); // 7-day suspension
        suspensionDate = endDate.toISOString().split('T')[0];
      } else if (currentViolationCount >= 2) {
        severity = 'permanent_block';
        newStatus = 'permanently_blocked';
      }

      await base44.entities.Violation.create({
        user_id: user.id,
        violation_type: formData.violation_type,
        severity,
        description: formData.description,
        admin_id: currentAdmin.id,
        expires_at: suspensionDate
      });

      await base44.entities.User.update(user.id, {
        violation_count: currentViolationCount + 1,
        account_status: newStatus,
        suspension_end_date: suspensionDate
      });

      let notificationMessage = '';
      if (severity === 'warning') {
        notificationMessage = `Warning: ${formData.description}. This is your first violation.`;
      } else if (severity === 'suspension') {
        notificationMessage = `Your account has been suspended for 7 days. Reason: ${formData.description}`;
      } else {
        notificationMessage = `Your account has been permanently blocked. Contact admin with ID proof to unblock.`;
      }

      await base44.entities.Notification.create({
        user_id: user.id,
        type: severity === 'warning' ? 'admin_warning' : severity === 'suspension' ? 'admin_suspension' : 'admin_block',
        title: severity === 'warning' ? 'Warning Issued' : severity === 'suspension' ? 'Account Suspended' : 'Account Blocked',
        message: notificationMessage
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['allViolations'] });
      queryClient.invalidateQueries({ queryKey: ['usersForViolations'] });
      queryClient.invalidateQueries({ queryKey: ['allUsers'] });
      setShowAddForm(false);
      setFormData({ user_email: '', violation_type: '', description: '', severity: 'warning' });
      toast.success('Violation added successfully');
    }
  });

  const getSeverityBadge = (severity) => {
    const colors = {
      warning: 'bg-yellow-100 text-yellow-800',
      suspension: 'bg-orange-100 text-orange-800',
      permanent_block: 'bg-red-100 text-red-800'
    };
    return <Badge className={colors[severity]}>{severity.replace('_', ' ')}</Badge>;
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-semibold">Violation Management</h3>
        <Button onClick={() => setShowAddForm(!showAddForm)} className="bg-red-600 hover:bg-red-700">
          <Plus className="w-4 h-4 mr-2" />
          Add Violation
        </Button>
      </div>

      {showAddForm && (
        <Card className="border-2 border-red-200">
          <CardContent className="p-6 space-y-4">
            <h3 className="font-semibold text-lg">Report New Violation</h3>
            
            <div className="space-y-2">
              <label className="text-sm font-medium">User Email</label>
              <Input
                placeholder="user@gvpce.ac.in"
                value={formData.user_email}
                onChange={(e) => setFormData({ ...formData, user_email: e.target.value })}
              />
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Violation Type</label>
              <Select value={formData.violation_type} onValueChange={(value) => setFormData({ ...formData, violation_type: value })}>
                <SelectTrigger>
                  <SelectValue placeholder="Select type" />
                </SelectTrigger>
                <SelectContent>
                  {VIOLATION_TYPES.map(type => (
                    <SelectItem key={type} value={type}>
                      {type.replace(/_/g, ' ')}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Description</label>
              <Textarea
                placeholder="Describe the violation..."
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                rows={3}
              />
            </div>

            <div className="p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
              <strong>Auto-escalation:</strong>
              <ul className="mt-1 list-disc list-inside">
                <li>1st violation → Warning</li>
                <li>2nd violation → 7-day Suspension</li>
                <li>3rd+ violation → Permanent Block</li>
              </ul>
            </div>

            <div className="flex gap-3">
              <Button variant="outline" onClick={() => setShowAddForm(false)} className="flex-1">
                Cancel
              </Button>
              <Button 
                onClick={() => addViolationMutation.mutate()}
                disabled={!formData.user_email || !formData.violation_type || !formData.description || addViolationMutation.isPending}
                className="bg-red-600 hover:bg-red-700 flex-1"
              >
                Add Violation
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      <div className="space-y-4">
        {violations.length === 0 ? (
          <Card>
            <CardContent className="flex flex-col items-center justify-center py-12 text-gray-500">
              <AlertTriangle className="w-16 h-16 mb-4 opacity-50" />
              <p>No violations recorded</p>
            </CardContent>
          </Card>
        ) : (
          violations.map(violation => {
            const user = users.find(u => u.id === violation.user_id);
            return (
              <Card key={violation.id} className="hover:shadow-lg transition-shadow">
                <CardContent className="p-4">
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1 space-y-2">
                      <div className="flex items-center gap-3">
                        <h3 className="font-semibold">{user?.full_name || 'Unknown User'}</h3>
                        {getSeverityBadge(violation.severity)}
                        {violation.is_active && (
                          <Badge className="bg-red-100 text-red-800">Active</Badge>
                        )}
                      </div>
                      
                      <div className="text-sm space-y-1">
                        <p className="text-gray-600">Email: {user?.email}</p>
                        <p className="text-gray-600">Type: {violation.violation_type?.replace(/_/g, ' ')}</p>
                        <p className="text-gray-700">Reason: {violation.description}</p>
                        <p className="text-gray-500">Date: {format(new Date(violation.created_date), 'MMM dd, yyyy HH:mm')}</p>
                        {violation.expires_at && (
                          <p className="text-orange-600">Expires: {format(new Date(violation.expires_at), 'MMM dd, yyyy')}</p>
                        )}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })
        )}
      </div>
    </div>
  );
}
